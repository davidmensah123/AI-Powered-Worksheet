<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Grading Worksheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose-styles h2 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .prose-styles p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        /* Simple spinning animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">

    <div class="w-full max-w-4xl mx-auto">
        <div id="worksheet-container" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <div class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">AI-Powered Grading Worksheet</h1>
                <p class="text-slate-500 mt-2">Answer the following questions. Your responses will be graded by AI.</p>
            </div>
            
            <!-- Questions Section -->
            <div id="questions-section" class="space-y-8">
                <!-- Questions will be dynamically inserted here -->
            </div>

            <div class="mt-10 text-center">
                <button id="submit-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:bg-slate-400 disabled:cursor-not-allowed">
                    Submit and Grade All Answers
                </button>
            </div>
        </div>

        <!-- Results Modal -->
        <div id="results-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col">
                <div class="p-6 border-b border-slate-200 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-900">Grading Results</h2>
                    <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button>
                </div>
                
                <!-- Loading State -->
                <div id="loading-state" class="p-8 text-center flex-grow flex flex-col items-center justify-center">
                    <div class="spinner"></div>
                    <p class="text-slate-600 font-medium mt-4">Grading in progress... Please wait.</p>
                </div>

                <!-- Results Content -->
                <div id="results-content" class="hidden p-6 sm:p-8 overflow-y-auto">
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 mb-8 text-center">
                        <h3 class="text-lg font-medium text-slate-500">Overall Performance</h3>
                        <div class="flex items-center justify-center space-x-4 sm:space-x-6 mt-2">
                            <div>
                                <p class="text-3xl sm:text-4xl font-bold text-slate-800" id="total-score-display"></p>
                                <p class="text-xs sm:text-sm text-slate-500">Total Score</p>
                            </div>
                            <div class="border-l border-slate-300 h-16"></div>
                             <div>
                                <p class="text-3xl sm:text-4xl font-bold text-slate-800" id="percentage-display"></p>
                                <p class="text-xs sm:text-sm text-slate-500">Percentage</p>
                            </div>
                            <div class="border-l border-slate-300 h-16"></div>
                            <div>
                                <p class="text-3xl sm:text-4xl font-bold text-blue-600" id="final-grade-display"></p>
                                <p class="text-xs sm:text-sm text-slate-500">Final Grade</p>
                            </div>
                        </div>
                    </div>

                    <div id="detailed-feedback-section" class="space-y-6">
                        <!-- Detailed feedback for each question will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            // IMPORTANT: In a real-world application, never expose your API key on the client-side.
            // This key should be stored in a secure backend environment.
            // For this self-contained example, we place it here.
            const API_KEY = "AIzaSyAbsNEq95jbCFV0xGBsylrRPvuiHmVgw8I"; // Replace with your Google Gemini API key if you have one, otherwise leave empty.

            const worksheetData = {
                totalMarks: 18,
                questions: [
                    {
                        id: 1,
                        text: "Compare diffusion and osmosis.",
                        marks: 6,
                        rubric: "Evaluate the answer on these points: 1. Defines diffusion (movement from high to low concentration). 2. Defines osmosis (movement of water across a partially permeable membrane). 3. States a similarity (e.g., both are passive/down a concentration gradient). 4. States a key difference (osmosis requires a membrane). 5. States another key difference (osmosis is specific to water). 6. Clarity and use of scientific terms are accurate.",
                        modelAnswer: "Diffusion is the net movement of particles from an area of higher concentration to an area of lower concentration. Osmosis is the net movement of water molecules across a partially permeable membrane from a region of higher water potential to a region of lower water potential. Both are passive processes that do not require energy. However, osmosis specifically involves water and requires a partially permeable membrane, whereas diffusion can be for any particle (e.g., gases, solutes) and does not require a membrane.",
                        answer: "",
                        score: 0,
                        feedback: ""
                    },
                    {
                        id: 2,
                        text: "Describe an experiment to investigate how the concentration of salt solution affects the mass of potato chips.",
                        marks: 6,
                        rubric: "Evaluate on these points: 1. Describes cutting identical potato chips and measuring initial mass. 2. Mentions preparing a range of salt concentrations and a control (pure water). 3. States placing chips in solutions for a fixed time. 4. Mentions controlling key variables (temperature, volume, time). 5. Describes removing chips, drying them, and measuring final mass. 6. Explains how to calculate the percentage change in mass for comparison.",
                        modelAnswer: "1. Cut several potato cylinders to the same size and mass, using a cork borer and ruler. 2. Prepare a range of salt solutions (e.g., 0.1M, 0.2M, 0.5M) and one beaker of pure water (control). 3. Place one potato cylinder in each beaker for a fixed time (e.g., 30 minutes). 4. Control variables like temperature, volume of solution, and potato surface area. 5. After the time is up, remove the cylinders, gently pat them dry, and reweigh them. 6. Calculate the percentage change in mass for each and plot a graph of concentration vs. percentage mass change.",
                        answer: "",
                        score: 0,
                        feedback: ""
                    },
                    {
                        id: 3,
                        text: "Explain active transport and describe two examples in biological systems.",
                        marks: 6,
                        rubric: "Evaluate on these points: 1. Defines active transport as movement against a concentration gradient. 2. States it requires energy from ATP. 3. Mentions the role of carrier proteins. 4. Provides a valid first example (e.g., mineral ion uptake by root hair cells). 5. Provides a valid second example (e.g., glucose absorption in the small intestine). 6. Clearly explains why one of the examples is active transport (e.g., concentration is higher in the root than the soil).",
                        modelAnswer: "Active transport is the movement of molecules or ions across a cell membrane against their concentration gradient (from a low to a high concentration). This process requires energy, which is supplied by ATP, and uses specific carrier proteins embedded in the membrane. Example 1: Mineral ions are absorbed from the soil into plant root hair cells, where the ion concentration is already higher than in the soil. Example 2: Glucose is absorbed from the small intestine into the bloodstream, even when the blood glucose concentration is higher.",
                        answer: "",
                        score: 0,
                        feedback: ""
                    }
                ]
            };

            const questionsSection = document.getElementById('questions-section');
            const submitBtn = document.getElementById('submit-btn');
            const resultsModal = document.getElementById('results-modal');
            const loadingState = document.getElementById('loading-state');
            const resultsContent = document.getElementById('results-content');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const detailedFeedbackSection = document.getElementById('detailed-feedback-section');
            const totalScoreDisplay = document.getElementById('total-score-display');
            const percentageDisplay = document.getElementById('percentage-display');
            const finalGradeDisplay = document.getElementById('final-grade-display');

            // --- FUNCTIONS ---

            function renderQuestions() {
                let html = '';
                worksheetData.questions.forEach((q, index) => {
                    html += `
                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                            <h2 class="text-lg font-semibold text-slate-800 mb-1">Question ${index + 1}</h2>
                            <p class="text-slate-600 mb-4 prose-styles">${q.text} (${q.marks} marks)</p>
                            <textarea
                                data-question-id="${q.id}"
                                class="w-full h-36 p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                placeholder="Type your answer here..."
                            ></textarea>
                             <div class="mt-4">
                                <button data-model-answer-id="${q.id}" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">Show Model Answer</button>
                                <div id="model-answer-${q.id}" class="hidden mt-2 p-4 bg-blue-50 border border-blue-200 rounded-lg text-slate-700 prose-styles">
                                    <p class="!m-0"><strong>Model Answer:</strong> ${q.modelAnswer}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                questionsSection.innerHTML = html;
            }

            function storeAnswers() {
                const textareas = document.querySelectorAll('textarea[data-question-id]');
                textareas.forEach(textarea => {
                    const questionId = parseInt(textarea.dataset.questionId);
                    const question = worksheetData.questions.find(q => q.id === questionId);
                    if (question) {
                        question.answer = textarea.value.trim();
                    }
                });
            }

            async function callGeminiAPI(question, answer, rubric) {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                
                const prompt = `
                    You are an AI examiner. Your task is to grade the student's answer out of 6 based on the provided rubric.
                    You MUST respond ONLY with a single, valid JSON object containing two keys: "score" (an integer between 0 and 6) and "feedback" (a concise, helpful string explaining the mark awarded, written in markdown).

                    Question: "${question}"
                    Rubric: "${rubric}"
                    Student's Answer: "${answer}"

                    Example JSON response: {"score": 4, "feedback": "You correctly identified two key points from the rubric. To improve, you should also discuss the long-term consequences."}
                `;

                if (!API_KEY) {
                    console.error("API Key is missing.");
                    // Return a mock response for UI testing if no key is provided
                    return new Promise(resolve => setTimeout(() => resolve({
                        score: Math.floor(Math.random() * 7),
                        feedback: "This is a mock response. Please add a valid Gemini API key to the script to enable real grading."
                    }), 1000));
                }
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                responseMimeType: "application/json",
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const data = await response.json();
                    const candidate = data.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return JSON.parse(candidate.content.parts[0].text);
                    } else {
                        throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    return { score: 0, feedback: `An error occurred while grading: ${error.message}` };
                }
            }

            function calculateGrade(percentage) {
                if (percentage > 70) return '9';
                if (percentage >= 65) return '8';
                if (percentage >= 60) return '7';
                if (percentage >= 50) return '6';
                if (percentage >= 40) return '5';
                if (percentage >= 30) return '4';
                if (percentage >= 25) return '3';
                if (percentage >= 15) return '2';
                if (percentage >= 10) return '1';
                return 'U';
            }

            function displayResults() {
                let detailedHtml = '';
                let totalScore = 0;

                worksheetData.questions.forEach((q, index) => {
                    totalScore += q.score;
                    detailedHtml += `
                        <div class="bg-white p-5 rounded-xl border border-slate-200">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-bold text-slate-800">Question ${index + 1}</h4>
                                <span class="text-lg font-bold ${q.score > 3 ? 'text-green-600' : 'text-red-600'} bg-slate-100 px-3 py-1 rounded-md">${q.score} / ${q.marks}</span>
                            </div>
                            <div class="prose-styles text-slate-600">
                                <p><strong>Your Answer:</strong> <em>"${q.answer || 'No answer provided.'}"</em></p>
                                <p><strong>Feedback:</strong> ${q.feedback}</p>
                            </div>
                        </div>
                    `;
                });

                const percentage = (totalScore / worksheetData.totalMarks) * 100;
                const finalGrade = calculateGrade(percentage);

                totalScoreDisplay.textContent = `${totalScore} / ${worksheetData.totalMarks}`;
                percentageDisplay.textContent = `${percentage.toFixed(1)}%`;
                finalGradeDisplay.textContent = finalGrade;
                detailedFeedbackSection.innerHTML = detailedHtml;

                loadingState.classList.add('hidden');
                resultsContent.classList.remove('hidden');
            }
            
            async function handleSubmit() {
                storeAnswers();

                const hasAnswers = worksheetData.questions.some(q => q.answer !== "");
                if (!hasAnswers) {
                    alert("Please answer at least one question before submitting.");
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Grading...';
                resultsModal.classList.remove('hidden');
                resultsContent.classList.add('hidden');
                loadingState.classList.remove('hidden');

                const gradingPromises = worksheetData.questions.map(q => 
                    callGeminiAPI(q.text, q.answer, q.rubric)
                );
                
                const results = await Promise.all(gradingPromises);
                
                results.forEach((result, index) => {
                    worksheetData.questions[index].score = result.score || 0;
                    worksheetData.questions[index].feedback = result.feedback || "No feedback provided.";
                });

                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit and Grade All Answers';

                displayResults();
            }

            // --- EVENT LISTENERS ---
            submitBtn.addEventListener('click', handleSubmit);
            closeModalBtn.addEventListener('click', () => {
                resultsModal.classList.add('hidden');
            });
            resultsModal.addEventListener('click', (e) => {
                 if (e.target === resultsModal) {
                    resultsModal.classList.add('hidden');
                 }
            });

            questionsSection.addEventListener('click', (e) => {
                if (e.target.matches('button[data-model-answer-id]')) {
                    const button = e.target;
                    const questionId = button.dataset.modelAnswerId;
                    const modelAnswerDiv = document.getElementById(`model-answer-${questionId}`);
                    
                    if (modelAnswerDiv) {
                        const isHidden = modelAnswerDiv.classList.toggle('hidden');
                        button.textContent = isHidden ? 'Show Model Answer' : 'Hide Model Answer';
                    }
                }
            });


            // --- INITIALIZATION ---
            renderQuestions();
            if (!API_KEY) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-r-lg';
                warningDiv.textContent = 'Warning: Gemini API key is not set. The app will use mock data for grading. To enable real AI grading, please add your API key to the script.';
                document.getElementById('worksheet-container').prepend(warningDiv);
            }
        });
    </script>
</body>
</html>

